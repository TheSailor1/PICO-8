pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
function _init()
	debug={}
	
	plr={
		x=64,
		y=64,
		w=8,
		h=8,
		dx=0,
		dy=0,
		spd=1.4,
		fric=0.7,
		moving=false,
		canmove=true,
		itime=0,
		col=8
	}
	
	sawballs={}
	ballcount=1
	maxballs=4
	
	coltab={2,2,9,9,10,10,14,14}
	tiles={}
	opentiles={}
	
	for y=1,15 do
		for x=1,15 do
			if mget(x,y)==1 then
					local rcol=deli(coltab,1+flr(rnd(#coltab)))
					add(tiles,{
						tx=x,
						ty=y,
						col=rcol,
						flp=false,
						match=false
					})
			end
		end
	end
	
end

function _update60()
	plr.moving=false
	debug[1]=plr.canmove
	
	foreach(sawballs,upd_ball)
	
	if #sawballs>1 then
		for i=1,#sawballs do
			for j=i+1,#sawballs do
				if sawballs[i].x+sawballs[i].w>=sawballs[j].x and
							sawballs[i].x<=sawballs[j].x+sawballs[j].w and
							sawballs[i].y+sawballs[i].h>sawballs[j].y and
							sawballs[i].y<=sawballs[j].y+sawballs[i].h then
								sawballs[i].xspd*=-1
								sawballs[j].xspd*=-1
								if sawballs[i].x<=sawballs[j].x then
									sawballs[i].x-=6
								else
									sawballs[i].x+=6
								end
				end
			end
		end
	end
	
	if #opentiles==2 then
		chk_flps()
	end
	
	if plr.itime>0 then
		plr.itime-=1
	end
	
	if plr.itime==0 then
		if btn(‚¨ÖÔ∏è) then
			plr.dx=-plr.spd
			plr.moving=true
		elseif btn(‚û°Ô∏è) then
			plr.dx=plr.spd
			plr.moving=true
		elseif btn(‚¨ÜÔ∏è) then
			plr.dy=-plr.spd
			plr.moving=true
		elseif btn(‚¨áÔ∏è) then
			plr.dy=plr.spd
			plr.moving=true
		end
	end
	
	if (plr.x<=plr.w) plr.x=plr.w
	if (plr.x+plr.w>127) plr.x=127-plr.w
	if (plr.y<=plr.h) plr.y=plr.h
	if (plr.y+plr.h>127) plr.y=127-plr.h
	
	if btnp(üÖæÔ∏è) then
		mak_sawball()
	end
	
	if btnp(‚ùé) then
		chk_ontile()
	end
	
	--friction
	plr.dx*=plr.fric
	plr.dy*=plr.fric
	
	--update pos
	plr.x+=plr.dx
	plr.y+=plr.dy
	
end

function _draw()
	cls()
	
	map()
	foreach(tiles,drw_fliptiles)
	
	foreach(sawballs,drw_ball)
	
	local bounceh=plr.moving==true and 4 or 2.4
	local bounce=sin(time()*bounceh)*1.1
	rrectfill(
		plr.x-8,
		(plr.y-8)+bounce,
		plr.w,plr.h,
		8,plr.col
	)
	
	
	if #debug>0 then
		for i=1,#debug do
			print(tostr(debug[i]),2,2+((i-1)*8),8)
		end
	end
end
-->8
--sawballs

function mak_sawball()
	local randx,randy
	
	if plr.dx<0 then
		randx=80+rnd(35)
	else
		randx=40+rnd(35)
	end
	if plr.dy<0 then
		randy=80+rnd(35)
	else
		randy=40+rnd(35)
	end
	
	add(sawballs,{
		x=randx,
		y=randy,
		w=8,
		h=8,
		xspd=rnd({0.6,-0.6}),
		yspd=rnd({0.6,-0.6})
	})
end

function drw_ball(b)
	rrectfill(
		b.x,
		b.y,
		b.w,b.h,
		10,12)
end

function upd_ball(b)
	if b.x+b.w>=plr.x-plr.w and
				b.x<=(plr.x-plr.w)+plr.w and
				b.y+b.h>=plr.y-plr.h and
				b.y<=(plr.y-plr.h)+plr.h then
				
				plr.itime=60
				
				
				if b.xspd>0 then
					b.x=(plr.x-plr.w)-(b.w)
					b.y=plr.y-plr.h
					b.xspd*=-1
				elseif b.xspd<0 then
					b.x=(plr.x-plr.w)+(b.w)
					b.y=plr.y-plr.h
					b.xspd*=-1
				end
				
	end
	
	if (b.x+b.w>=127) b.xspd*=-1 b.x=127-b.w
	if (b.x<=0) b.xspd*=-1 b.x=0
	if (b.y<=0) b.yspd*=-1 b.y=0
	if (b.y+b.h>=127) b.yspd*=-1 b.y=127-b.h
	
	b.x+=b.xspd
	b.y+=b.yspd
end
-->8
--player

function chk_ontile()
	local px=flr((plr.x-(plr.w/2))/8)
	local py=flr((plr.y-(plr.h/2))/8)
	
	if mget(px,py)==1 then
		mset(px,py,2)
		
		foreach(tiles,flptile)
		justflp={
			tx=px,
			ty=py
		}
		
		
		if ballcount==2 then
			if #sawballs<maxballs then
				mak_sawball()
			end
			ballcount=1
		else
			ballcount+=1
		end
	end
end

function drw_fliptiles(t)
	if t.flp then
		circfill((t.tx*8)+4,(t.ty*8)+3,1,t.col)
	end
end

function flptile(t)
	local px=flr((plr.x-(plr.w/2))/8)
	local py=flr((plr.y-(plr.h/2))/8)
	
	if t.tx==px and t.ty==py and t.flp==false then
		t.flp=true
		add(opentiles,t)
		plr.col=t.col
	end 
end

function chk_flps()
	if opentiles[1].col!=opentiles[2].col then
		mset(opentiles[1].tx,opentiles[1].ty,1)
		mset(opentiles[2].tx,opentiles[2].ty,1)
		for i=1,#tiles do
			for j=1,2 do
				if tiles[i].tx==opentiles[j].tx and
					tiles[i].ty==opentiles[j].ty then
						tiles[i].flp=false
				end
			end
		end
	end
	opentiles={}
end
__gfx__
0000000055555555dddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000055555555d000000d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070055666555d000000d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700055656555d000000d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700055656555d000000d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070055666555d000000d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000055656555d000000d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000055555555dddddddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
